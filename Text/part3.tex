\section{Лекция 3}
Организационные вопросы: дополнительная пара для проверки домашенго задания. 
\begin{hw}Задача: написать свой примитивный отладчик. 2 момента: реализовать трассировку и breakpoint'ы. Загрузить файл - будет проблемно. Выполняем функции операционной системы. 
\end{hw}
\begin{rem}
MS-DOS: Тим Патерсон.
DR-DOS: Гарри Килдалл (король 8-битных операционок). Ему IBM предлагали контракт, но он отказался.\end{rem}

Как открыть файл? MS-DOS переняла наследие от других ОС. Фредерик Брукс - получил Тьюринговскую премию. Shift + F1 - искать функции для работы с файлами. 

OF(15) устаревшая функция. Используем функции с 3Dh (60-го) номера. Пользуемся этими функциями. Важное слово handle(ручка к ящику). Чтобы открыть файл нужно "описать ящик". Есть основные handle: stdin, stdout, stderr. Для нас тут handle c 5-м номером. Обращаем внимание на зависимость от CF (для возврата информации об ошибки). JNC (jump no carry) удобная команда. Перкидываем handle в BX (посмотрели в close). Нужен буть READ. Поиск длины файла: lseek(66-я функция) с конца до 00. Эрик Рэймонд. После открытия нужно делать seek 3-го типа. Так узнаем длину файла. Можно длину указать (FF). Из диска - в память загрузились и больше не читаем. Нужно обработаться все завершения работы.
Ограничения: отлаживаемая программа .COM и завершается ret'м. Сам отладчик .COM.

Понадобится стэковый фокус. Прерывания - 2е дело(внутреннее дело). 

~//

Работаем в debugger'е.
Прыжок на 107, но 107 нет. в 108
90 - универсальная затиралка. Когда мы не ставим ключ /m => получили "nop".
E9 2 байта (величина прыжка).EB 1 байт.

Ассемблер, стоя на строчке - не знает, где будет старт. То он кладет максимум, 3 байта. Если заменит 3 на 2, то адреса поедут, поэтому оставляет 3 байта и вставляет "nop". С ключем /m мы уже будем знать, что обойдемся 2-мя байтами, т.е. на следующий проход сделаем все хорошо, без nop.

\begin{hw} Задача - сделать столько проходов, сколько мы задаем.\end{hw}

Дизъасемблирует все подрярд. Процессор не понимает разницу между данными и инструкциями. Идет по логике линейоного ассемблера. 


\begin{rem}Говард Эйкен. Алан Тьюринг. 2 разных типа архитектуры: Гарвардская, Принстонская. \end{rem}


Попали нетуда, но IP верно указывает. Cntr + G и прямо указываем то, что нужно. 

0 в стеке положил DOS, чтобы ret'm сделать CD 20. Что лежит в стэке, чтобы мы вернулись. call делает call и кладет следующий за собой адрес.	

В начале сегмента лежит наша программа.

\begin{hw}Нужно стэком убить свой код. Чтобы стэк дошел до наших инструкций и затер код.\end{hw}

Golf - решить задачу, уменьшив размер программы. 

ret - один, но возвращать он будет нас в разные места.

Как смотреть результат работы ассемблера без дебагера? 	Получаем листинг программы (tasm /m/l 5.asm).\slshape shl ax, 4 \upshape => разваливалась в 4 команды \slshape shr ax,1\upshape. Это некруто. Написали .486 - разрешили использовать команды 486 процессора. Теперь, посмотрел листинг, видим, что у нас все заменилось на одну 3-х байтовую команду.

\subsection{Пишем прерывания}
Использование программных прерываний. Пишем свой код.
Пишем свою функцию для вывода строки.


256 векторов. Младшие 8 - (0-7) процессорные исключения. Пример 0-е исключени - это деление на 0. Процессор не может выполнить команду. Следующие 8 штук (8-F) аппаратные int'ы первого контроллера, 8 таймер, 9 клавиатура. (10h - 1Fh) BIOS'а прерывания, 13 - работа с диском, 16 клавиатура. (20h - 2Fh) забрал себе DOS. Итого: 48 номеров. Посмотреть в Brown'e что осталось для пользователей. Это от (F0-FF) зарезервировано изначально.   

iret выталкивает 3 слова. Заполняет IP, CS, RFLAGS. 25, 35 поставить вектор, снять вектор.
ds всегда обещан как cs.   

Делаем диспетчеры и вызываем разные функции.
Shift + F3 = убрать выделение.
Написали разные функции, вызываемые в зависимости от нашего условия. 

Гарри Киллдал. Создавал массив точек входа. Можно все тесты убрать. Диспетчеризация в начале. В самих функциях ничего не пишем.

mov dx, (offset start + 15)/16;

Ошибка будет. Relative quantity illegal. Тут требуется какая-то типизация. Смещение не рассматривает как смещение. Нужно вычесть то, и добавить 100h.

Разделяли на клиентскую и резидентскую часть. Заполнилась колонка: взятые вектора.

Посмотрели разраотку сервисного разработичка прерываний. 
\begin{hw} Думать про задачу. Взять вектор трассировка - первый int, breakpoint 3 - й int \end{hw}

Нужно грамотно проследить, куда возвращаться. Флаги для трассировки. Сначала перехватить int 1. Нужно отследить завершение программы. 
\begin{enumerate}
\item Загрузить программу в память. 
\item Сохранить регистры.
\item Установить флаги.
\item Печатать все IP.  
\item Когда ret, должны выйти.
\item Breakpoint на IP. 
\end{enumerate}